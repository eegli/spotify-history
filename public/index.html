<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Token</title>
  </head>
  <body>
    <h1 id="title">Spotify Auth Token</h1>
    <h3 id="info"></h3>
    <script>
      (async () => {
        const REDIRECT_URL = 'http://localhost:3000';
        const refreshTokenUrl = 'https://accounts.spotify.com/api/token';
        const localGetCredentialsUrl = 'http://localhost:3000/credentials';
        const localSubmitTokenUrl = 'http://localhost:3000/submit';

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const receivedState = urlParams.get('state');

        if (code) {
          const authUrl = '';
          let clientId;
          let clientSecret;
          let state;

          try {
            const credentialsRes = await fetch(localGetCredentialsUrl, {
              credentials: 'same-origin',
            });
            const credentials = await credentialsRes.json();

            console.log({
              reveived: receivedState,
              origin: credentials.state,
            });

            if (credentials.state !== receivedState) {
              throw Error("States don't match");
            }

            clientId = credentials.clientId;
            clientSecret = credentials.clientSecret;
            state = credentials.state;

            const params = {
              grant_type: 'authorization_code',
              code,
              redirect_uri: REDIRECT_URL,
            };

            const tokenParams = new URLSearchParams();
            for (const prop in params) {
              tokenParams.set(prop, params[prop]);
            }

            const tokenRes = await fetch(refreshTokenUrl, {
              method: 'POST',
              headers: {
                'Content-type': 'application/x-www-form-urlencoded',
                Authorization:
                  'Basic ' + window.btoa(clientId + ':' + clientSecret),
              },
              body: tokenParams,
            });
            const token = await tokenRes.json();
            if (token.access_token) {
              document.getElementById('info').innerHTML =
                'Authentication successful. You can now close this window';

              fetch(localSubmitTokenUrl, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                  'Content-type': 'application/json',
                },
                body: JSON.stringify({
                  ...token,
                }),
              });
            }
          } catch (err) {
            console.error('Something went wrong');
          }
        }
      })();
    </script>
  </body>
</html>
